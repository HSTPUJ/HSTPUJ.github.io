<!DOCTYPE html>
<!--
 @license
 Copyright 2019 Google LLC. All Rights Reserved.
 SPDX-License-Identifier: Apache-2.0
-->
<html>

  <head>

    <title>SIMO PUJ - DEMO</title>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="description" content="Proyecto de la Pontificia Universidad Javeriana de Cali">
    <meta name="keywords" content="Ganadería, Estadística, Cali, Cauca, Colombia, Tecnología">
    <meta name="author" content="Alejandro Silva Enríquez">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta property = "og:url" content = "https://HSTPUJ.github.io"> 

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/aos.css">

    <link rel="icon" type="image/x-icon" href="/images/ico.ico">

    <!-- MAIN CSS -->  
    <link rel="stylesheet" href="css/tooplate-gymso-style.css">


    <!-- Theme android --> 
    <meta name="theme-color" content="#000000">

    <!-- Script PolyFill --> 
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    
    <!-- Estilos -->
    <style>
      /**
      * @license
      * Copyright 2019 Google LLC. All Rights Reserved.
      * SPDX-License-Identifier: Apache-2.0
      */

      #map {
        height: 100%;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #floating-panel {
        position: absolute;
        top: 10px;
        left: 25%;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: center;
        font-family: "Roboto", "sans-serif";
        line-height: 30px;
        padding-left: 10px;
      }

      #floating-panel {
        background-color: #fff;
        border: 1px solid #999;
        left: 25%;
        padding: 5px;
        position: absolute;
        top: 10px;
        z-index: 5;
      }

    </style>

    <!-- Scripts -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCHmJ6UhGw_XxJ4xYnKkfo0XAXx0KEeGog&callback=initMap&libraries=visualization&v=weekly" defer></script>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <script>
      /**
       * @license
       * Copyright 2019 Google LLC. All Rights Reserved.
       * SPDX-License-Identifier: Apache-2.0
       */
      let map, heatmap, x, y, z;

      function loadmaps(){
        $.getJSON("https://api.thingspeak.com/channels/1690392/fields/1/last.json?api_key=UUKYCNZYHWOJNOK5", function(result){
        //$.getJSON("./pruebasjson/latitud.json", function(result){
        globalThis.m = result;
        //x=Number(3.634441);
        m=String(m.field1);
        x=m.split(',').map(Number);
        });
            $.getJSON("https://api.thingspeak.com/channels/1690392/fields/2/last.json?api_key=UUKYCNZYHWOJNOK5", function(result){
            //$.getJSON("./pruebasjson/longitud.json", function(result){
            m = result;
            //y=Number(-76.335292);
            m=String(m.field2);
            y=m.split(',').map(Number);
            });
              $.getJSON("https://api.thingspeak.com/channels/1690392/fields/3/last.json?api_key=UUKYCNZYHWOJNOK5", function(result){
              //$.getJSON("./pruebasjson/hora.json", function(result){
              m = result;
              //z=String("12:30");
              m=String(m.field3);
              z=m.split(',');
              }).done(function() {
                  window.initMap = initMap(x,y,z);
        });
        return[x,y,z];        
      }

      //Inicializar
      function initMap(x,y,z) {
        // Posición inicial del mapa
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 17.5,
          center: new google.maps.LatLng(x[x.length-1], y[x.length-1] ),
          mapTypeId: "satellite",
        });

        // Formato de marcadores
        const image = {
          url: " ",
          // Medida del marcador
          size: new google.maps.Size(10, 10),
          // Origen
          origin: new google.maps.Point(0, 0),
          // Ancla de marcador
          anchor: new google.maps.Point(0, 0),
        };

        // Generación de puntos y marcadores
        for (i = 0; i < x.length; i++) {  
          marker = new google.maps.Marker({
            position: new google.maps.LatLng(x[i], y[i]),
            icon: image,
            map: map
          });

          google.maps.event.addListener(marker, 'click', (function(marker, i) {
            return function() {
              var infowindow = new google.maps.InfoWindow({
                content: '<p><b>SIMO</b><br>Coordenadas: ' + x[i] +', '+y[i]+'<br>Hora en este punto: ' + z[i] + '</p>'
              });
              infowindow.open(map, marker);
            }
          })(marker, i));

          heatmap = new google.maps.visualization.HeatmapLayer({
            data: getPoints(x,y,z,i),
            map: map,
          });
        }

      //Heatmap
        heatmap.set("radius", heatmap.get("radius") ? null : 20);
      }

      // Puntos en el mapa
      function getPoints(x,y,z,i) {
        return [
          new google.maps.LatLng(x[i], y[i]),
        ];
      }

      //Llamar a la función loadmaps una sola vez
      let intervalId = window.setInterval(function(){
                datos=loadmaps();
                window.clearInterval(intervalId);
                /*var i = 0;
                i = i+1;
                if (i = 100) {
                  window.clearInterval(intervalId);
                }*/
                    }, 1);
    </script>
  </head>

  <body>
    <!-- Barra de navegación -->
    <nav class="navbar navbar-expand-lg fixed-top">
      <div class="container">

          <a class="navbar-brand" href="#home">SIMO</a>

          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false"
              aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
          </button>

          <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav ml-lg-auto">
                  <li class="nav-item">
                      <a href="https://hstpuj.github.io/#home" class="nav-link smoothScroll">Inicio</a>
                  </li>

                  <li class="nav-item">
                      <a href="https://hstpuj.github.io/#about" class="nav-link smoothScroll">Dispositivo</a>
                  </li>

                  <li class="nav-item">
                      <a href="https://hstpuj.github.io/#class" class="nav-link smoothScroll">Mediciones</a>
                  </li>

                  <li class="nav-item">
                      <a href="https://hstpuj.github.io/#schedule" class="nav-link smoothScroll">Características</a>
                  </li>

                  <li class="nav-item">
                      <a href="https://hstpuj.github.io/#contact" class="nav-link smoothScroll">Contacto</a>
                  </li>

                  <li class="nav-item">
                      <a href="https://hstpuj.github.io/demo.html" class="nav-link smoothScroll">DEMO</a>
                  </li>
              </ul>

              <ul class="social-icon ml-lg-3">
                  <li><a href="#" class="fa fa-facebook"></a></li>
                  <li><a href="#" class="fa fa-twitter"></a></li>
                  <li><a href="#" class="fa fa-instagram"></a></li>
              </ul>

              <ul class="social-icon ml-lg-3">
                <li><a href="https://api.thingspeak.com/channels/1690392/fields/1/last.json" class="nav-link" style="position: absolute; bottom: 0; left: 0; right:0px;" download="latitud.json">Descargar</a></li>
                
            </ul>
          </div>

      </div>
    </nav>

    <!-- Mapa -->
    <div id="map"></div>
  </body>

</html>
